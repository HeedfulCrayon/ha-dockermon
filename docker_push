#!/bin/bash
echo "Logging in to Docker as $DOCKER_USERNAME"
echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
case "$1" in
    master )
        docker build --build-arg BASE=node:10.16 -t philhawthorne/ha-dockermon:latest .
        docker run --rm --privileged multiarch/qemu-user-static:register --reset
        docker build --build-arg BASE=balenalib/raspberrypi3-node:10.16 -t philhawthorne/ha-dockermon:arm .
        docker push philhawthorne/ha-dockermon:latest
        docker push philhawthorne/ha-dockermon:arm
        ;;
    edge )
        echo "Tagging and pushing images as edge"
        docker build --build-arg BASE=node:10.16 -t philhawthorne/ha-dockermon:edge .
        # prepare qemu
        docker run --rm --privileged multiarch/qemu-user-static:register --reset
        docker build --build-arg BASE=balenalib/raspberrypi3-node:10.16 -t philhawthorne/ha-dockermon:edge-arm .
        echo "Pushing standard edge image to Dockerhub"
        docker push philhawthorne/ha-dockermon:edge
        echo "Pushing arm edge image to Dockerhub"
        docker push philhawthorne/ha-dockermon:edge-arm

        echo "Creating manifest"
        docker manifest create --amend \
		philhawthorne/ha-dockermon:edge \
		philhawthorne/ha-dockermon:edge-arm \
        docker manifest annotate philhawthorne/ha-dockermon:edge-arm --arch arm
        echo "Pushing manifest"
		docker manifest push philhawthorne/ha-dockermon:edge
        ;;
    *)
        echo "Tagging release $1"
        docker build --build-arg BASE=node:10.16 -t philhawthorne/ha-dockermon:"$1" .
        # prepare qemu
        docker run --rm --privileged multiarch/qemu-user-static:register --reset
        docker build --build-arg BASE=balenalib/raspberrypi3-node:10.16 -t philhawthorne/ha-dockermon:"$1"-arm .
        docker push philhawthorne/ha-dockermon:"$1"
        docker push philhawthorne/ha-dockermon:"$1"-arm
        ;;
    esac